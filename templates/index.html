<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tmux Control Panel v1</title>
    
    <!-- xterm.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f0f23;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --accent: #4ecca3;
            --accent-hover: #3db892;
            --danger: #e74c3c;
            --danger-hover: #c0392b;
            --border: #2d2d44;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container { max-width: 1800px; margin: 0 auto; padding: 20px; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        h1::before { content: "â¬¢"; color: var(--accent); }

        .version-badge {
            font-size: 0.7rem;
            background: var(--accent);
            color: var(--bg-primary);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .header-actions { display: flex; gap: 12px; align-items: center; }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--accent); color: var(--bg-primary); }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: var(--danger-hover); }
        .btn-small { padding: 6px 12px; font-size: 0.75rem; }

        .tabs-container {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: var(--bg-tertiary);
            padding: 8px;
            border-radius: 8px;
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .tab:hover { background: var(--bg-secondary); color: var(--text-primary); }
        .tab.active { background: var(--accent); color: var(--bg-primary); }
        .tab .close-tab { opacity: 0.6; font-size: 1rem; line-height: 1; }
        .tab:hover .close-tab { opacity: 1; }

        .session-panel {
            display: none;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
        }
        .session-panel.active { display: block; }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
        }

        .panel-info { display: flex; align-items: center; gap: 16px; }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .panel-actions { display: flex; gap: 8px; flex-wrap: wrap; }

        .terminal-wrapper { padding: 0; background: #000; }
        .terminal-container { height: 450px; }
        .xterm { padding: 4px; }

        .quick-actions {
            padding: 12px 20px;
            background: rgba(0,0,0,0.2);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            border-top: 1px solid var(--border);
        }
        .quick-actions-label { font-size: 0.75rem; color: var(--text-secondary); margin-right: 8px; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            width: 100%;
            max-width: 500px;
        }
        .modal h2 { margin-bottom: 20px; font-size: 1.25rem; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.875rem; color: var(--text-secondary); }
        .form-group input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        .form-group input:focus { outline: none; border-color: var(--accent); }

        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; }

        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-state h2 { margin-bottom: 12px; color: var(--text-primary); }

        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1001; }
        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 8px;
            animation: slideIn 0.3s ease;
        }
        .toast.error { border-color: var(--danger); }
        .toast.success { border-color: var(--accent); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .debug-info { font-size: 0.7rem; color: var(--text-secondary); padding: 4px 8px; background: var(--bg-tertiary); border-radius: 4px; }
        .terminal-hint { font-size: 0.7rem; color: var(--text-secondary); padding: 4px 12px; background: var(--bg-tertiary); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Tmux Control Panel <span class="version-badge">v1</span></h1>
            <div class="header-actions">
                <span class="debug-info" id="debug-info">Ready</span>
                <button class="btn-secondary" onclick="refreshAll()">â†» Refresh</button>
                <button class="btn-primary" onclick="showNewSessionModal()">+ New Session</button>
            </div>
        </header>

        <div class="tabs-container" id="tabs-container"></div>

        <div id="sessions-container">
            <div class="empty-state" id="empty-state">
                <h2>No Sessions</h2>
                <p>Create a new session to get started</p>
            </div>
        </div>
    </div>

    <!-- New Session Modal -->
    <div class="modal-overlay" id="new-session-modal">
        <div class="modal">
            <h2>Create New Session</h2>
            <div class="form-group">
                <label for="session-name">Session Name</label>
                <input type="text" id="session-name" placeholder="my-session" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="working-dir">Working Directory (optional)</label>
                <input type="text" id="working-dir" placeholder="/home/user/project">
            </div>
            <div class="form-group">
                <label for="initial-command">Initial Command (optional)</label>
                <input type="text" id="initial-command" placeholder="npm run dev">
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="hideNewSessionModal()">Cancel</button>
                <button class="btn-primary" onclick="createSession()">Create</button>
            </div>
        </div>
    </div>

    <!-- Command Modal -->
    <div class="modal-overlay" id="command-modal">
        <div class="modal">
            <h2>Add Quick Command</h2>
            <div class="form-group">
                <label for="cmd-label">Button Label</label>
                <input type="text" id="cmd-label" placeholder="Build" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="cmd-command">Command</label>
                <input type="text" id="cmd-command" placeholder="npm run build">
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="hideCommandModal()">Cancel</button>
                <button class="btn-primary" onclick="addQuickCommand()">Add</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
        const API_BASE = '';
        let sessions = [];
        let activeSession = null;
        let refreshIntervals = {};
        let customCommands = {};
        let terminals = {};
        let fitAddons = {};
        let lastContent = {};

        const defaultCommands = [
            { label: 'â¹ Stop', command: null, signal: 'INT' },
            { label: 'â¸ Suspend', command: null, signal: 'STOP' },
            { label: 'ðŸ”„ Clear', command: 'clear' },
        ];

        function updateDebug(msg) {
            document.getElementById('debug-info').textContent = msg;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadCommands();
            loadSessions();
            
            document.getElementById('session-name').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') createSession();
            });

            window.addEventListener('resize', () => {
                Object.keys(fitAddons).forEach(name => {
                    if (fitAddons[name] && terminals[name]) {
                        try {
                            fitAddons[name].fit();
                            resizeTmuxPane(name);
                        } catch (e) {}
                    }
                });
            });
        });

        async function resizeTmuxPane(sessionName) {
            const term = terminals[sessionName];
            if (!term) return;
            try {
                await fetch(`${API_BASE}/api/sessions/${sessionName}/resize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cols: term.cols, rows: term.rows })
                });
            } catch (e) {}
        }

        async function loadCommands() {
            try {
                const response = await fetch(`${API_BASE}/api/commands`);
                const data = await response.json();
                if (data.success) customCommands = data.commands;
            } catch (error) {
                customCommands = {};
            }
        }

        async function loadSessions() {
            try {
                updateDebug('Loading...');
                const response = await fetch(`${API_BASE}/api/sessions`);
                const data = await response.json();
                
                if (data.success) {
                    sessions = data.sessions;
                    renderTabs();
                    renderPanels();
                    
                    if (sessions.length > 0 && !activeSession) {
                        activateSession(sessions[0].name);
                    }
                    
                    document.getElementById('empty-state').style.display = 
                        sessions.length === 0 ? 'block' : 'none';
                    
                    updateDebug(`${sessions.length} session(s)`);
                }
            } catch (error) {
                updateDebug('Error: ' + error.message);
            }
        }

        function renderTabs() {
            const container = document.getElementById('tabs-container');
            container.innerHTML = sessions.map(session => `
                <button class="tab ${session.name === activeSession ? 'active' : ''}" 
                        onclick="activateSession('${session.name}')">
                    <span>${session.display_name}</span>
                    <span class="close-tab" onclick="event.stopPropagation(); destroySession('${session.name}')">Ã—</span>
                </button>
            `).join('');
        }

        function renderPanels() {
            const container = document.getElementById('sessions-container');
            
            container.querySelectorAll('.session-panel').forEach(panel => {
                const name = panel.dataset.session;
                if (!sessions.find(s => s.name === name)) {
                    panel.remove();
                    cleanupSession(name);
                }
            });

            sessions.forEach(session => {
                if (!container.querySelector(`[data-session="${session.name}"]`)) {
                    const panel = createPanelElement(session);
                    container.appendChild(panel);
                    initializeTerminal(session.name);
                    startRefreshing(session.name);
                }
            });

            container.querySelectorAll('.session-panel').forEach(panel => {
                panel.classList.toggle('active', panel.dataset.session === activeSession);
            });
        }

        function createPanelElement(session) {
            const panel = document.createElement('div');
            panel.className = 'session-panel';
            panel.dataset.session = session.name;
            const commands = customCommands[session.name] || [];
            
            panel.innerHTML = `
                <div class="panel-header">
                    <div class="panel-info">
                        <div class="status-indicator"></div>
                        <strong>${session.display_name}</strong>
                    </div>
                    <div class="panel-actions">
                        ${defaultCommands.map(cmd => 
                            cmd.signal 
                                ? `<button class="btn-secondary btn-small" onclick="sendSignal('${session.name}', '${cmd.signal}')">${cmd.label}</button>`
                                : `<button class="btn-secondary btn-small" onclick="runCommand('${session.name}', '${cmd.command}')">${cmd.label}</button>`
                        ).join('')}
                        <button class="btn-danger btn-small" onclick="destroySession('${session.name}')">âœ• Close</button>
                    </div>
                </div>
                <div class="terminal-wrapper">
                    <div class="terminal-container" id="terminal-${session.name}"></div>
                </div>
                <div class="terminal-hint">Click terminal to focus â€¢ Type directly â€¢ Ctrl+C to stop</div>
                <div class="quick-actions" id="quick-actions-${session.name}">
                    <span class="quick-actions-label">Quick Commands:</span>
                    ${commands.map((cmd, i) => 
                        `<button class="btn-secondary btn-small" onclick="runCommand('${session.name}', '${cmd.command.replace(/'/g, "\\'")}')">${cmd.label}</button><button class="btn-secondary btn-small" style="padding:6px 6px;margin-left:-4px;opacity:0.6" onclick="deleteQuickCommand('${session.name}', ${i})" title="Delete">Ã—</button>`
                    ).join('')}
                    <button class="btn-secondary btn-small" onclick="showCommandModal('${session.name}')">+ Add</button>
                </div>
            `;
            return panel;
        }

        function initializeTerminal(sessionName) {
            const container = document.getElementById(`terminal-${sessionName}`);
            if (!container) return;

            const term = new Terminal({
                cursorBlink: true,
                cursorStyle: 'block',
                fontSize: 14,
                fontFamily: 'Consolas, "Courier New", monospace',
                theme: {
                    background: '#0c0c0c',
                    foreground: '#cccccc',
                    cursor: '#4ecca3',
                    cursorAccent: '#0c0c0c',
                    selectionBackground: 'rgba(78, 204, 163, 0.3)',
                    black: '#0c0c0c',
                    red: '#cd3131',
                    green: '#0dbc79',
                    yellow: '#e5e510',
                    blue: '#2472c8',
                    magenta: '#bc3fbc',
                    cyan: '#11a8cd',
                    white: '#e5e5e5',
                    brightBlack: '#666666',
                    brightRed: '#f14c4c',
                    brightGreen: '#23d18b',
                    brightYellow: '#f5f543',
                    brightBlue: '#3b8eea',
                    brightMagenta: '#d670d6',
                    brightCyan: '#29b8db',
                    brightWhite: '#ffffff'
                },
                scrollback: 5000,
                convertEol: true
            });

            const fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);

            const webLinksAddon = new WebLinksAddon.WebLinksAddon();
            term.loadAddon(webLinksAddon);

            term.open(container);
            
            setTimeout(() => {
                fitAddon.fit();
                resizeTmuxPane(sessionName);
            }, 100);

            terminals[sessionName] = term;
            fitAddons[sessionName] = fitAddon;

            // Send keystrokes to tmux
            term.onData(data => {
                sendRawKeys(sessionName, data);
            });

            container.addEventListener('click', () => term.focus());
        }

        function cleanupSession(sessionName) {
            if (refreshIntervals[sessionName]) {
                clearInterval(refreshIntervals[sessionName]);
                delete refreshIntervals[sessionName];
            }
            if (terminals[sessionName]) {
                terminals[sessionName].dispose();
                delete terminals[sessionName];
            }
            delete fitAddons[sessionName];
            delete lastContent[sessionName];
        }

        function activateSession(name) {
            activeSession = name;
            renderTabs();
            
            document.querySelectorAll('.session-panel').forEach(panel => {
                panel.classList.toggle('active', panel.dataset.session === name);
            });
            
            setTimeout(() => {
                if (fitAddons[name]) fitAddons[name].fit();
                if (terminals[name]) terminals[name].focus();
            }, 50);
            
            refreshTerminal(name);
        }

        function startRefreshing(sessionName) {
            if (refreshIntervals[sessionName]) return;
            refreshTerminal(sessionName);
            refreshIntervals[sessionName] = setInterval(() => refreshTerminal(sessionName), 100);  // 100ms for smooth cursor
        }

        async function refreshTerminal(sessionName) {
            try {
                const response = await fetch(`${API_BASE}/api/sessions/${sessionName}/terminal`);
                const data = await response.json();
                
                if (data.success && terminals[sessionName]) {
                    const term = terminals[sessionName];
                    const content = data.content || '';
                    
                    // Check if content changed (redraw needed)
                    const contentChanged = lastContent[sessionName] !== content;
                    
                    if (contentChanged) {
                        lastContent[sessionName] = content;
                        
                        // Hide cursor, go home, clear screen, write content
                        term.write('\x1b[?25l\x1b[H\x1b[2J');
                        term.write(content);
                    }
                    
                    // ALWAYS update cursor position
                    const row = (data.cursor_y || 0) + 1;
                    const col = (data.cursor_x || 0) + 1;
                    term.write(`\x1b[${row};${col}H`);
                    term.write('\x1b[?25h');  // Show cursor
                }
            } catch (error) {
                console.error('Refresh error:', error);
            }
        }

        async function sendRawKeys(sessionName, keys) {
            try {
                await fetch(`${API_BASE}/api/sessions/${sessionName}/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keys, enter: false, raw: true })
                });
                setTimeout(() => refreshTerminal(sessionName), 30);
                setTimeout(() => refreshTerminal(sessionName), 80);
            } catch (error) {
                console.error('Send error:', error);
            }
        }

        async function createSession() {
            const name = document.getElementById('session-name').value.trim();
            const workingDir = document.getElementById('working-dir').value.trim();
            const initialCommand = document.getElementById('initial-command').value.trim();
            
            if (!name) { showToast('Please enter a session name', 'error'); return; }
            
            try {
                const response = await fetch(`${API_BASE}/api/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, working_dir: workingDir || undefined, initial_command: initialCommand || undefined })
                });
                const data = await response.json();
                
                if (data.success) {
                    hideNewSessionModal();
                    await loadSessions();
                    activateSession(data.session);
                    showToast('Session created', 'success');
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast('Failed to create session', 'error');
            }
        }

        async function destroySession(sessionName) {
            if (!confirm(`Destroy session "${sessionName.replace('cp-', '')}"?`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/sessions/${sessionName}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    cleanupSession(sessionName);
                    if (activeSession === sessionName) activeSession = null;
                    await loadSessions();
                    showToast('Session destroyed', 'success');
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast('Failed to destroy session', 'error');
            }
        }

        async function runCommand(sessionName, command) {
            try {
                await fetch(`${API_BASE}/api/sessions/${sessionName}/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command })
                });
                setTimeout(() => refreshTerminal(sessionName), 50);
            } catch (error) {
                showToast('Failed to run command', 'error');
            }
        }

        async function sendSignal(sessionName, signal) {
            try {
                await fetch(`${API_BASE}/api/sessions/${sessionName}/signal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ signal })
                });
                setTimeout(() => refreshTerminal(sessionName), 50);
            } catch (error) {
                showToast('Failed to send signal', 'error');
            }
        }

        function showNewSessionModal() {
            document.getElementById('session-name').value = '';
            document.getElementById('working-dir').value = '';
            document.getElementById('initial-command').value = '';
            document.getElementById('new-session-modal').classList.add('active');
            document.getElementById('session-name').focus();
        }
        function hideNewSessionModal() { document.getElementById('new-session-modal').classList.remove('active'); }

        let commandModalSession = null;
        function showCommandModal(sessionName) {
            commandModalSession = sessionName;
            document.getElementById('cmd-label').value = '';
            document.getElementById('cmd-command').value = '';
            document.getElementById('command-modal').classList.add('active');
            document.getElementById('cmd-label').focus();
        }
        function hideCommandModal() { document.getElementById('command-modal').classList.remove('active'); commandModalSession = null; }

        async function addQuickCommand() {
            const label = document.getElementById('cmd-label').value.trim();
            const command = document.getElementById('cmd-command').value.trim();
            if (!label || !command) { showToast('Please fill in all fields', 'error'); return; }
            
            try {
                const response = await fetch(`${API_BASE}/api/commands/${commandModalSession}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ label, command })
                });
                const data = await response.json();
                if (data.success) {
                    customCommands[commandModalSession] = data.commands;
                    updateQuickActionsBar(commandModalSession);
                    hideCommandModal();
                    showToast('Command added', 'success');
                }
            } catch (error) {
                showToast('Failed to add command', 'error');
            }
        }

        async function deleteQuickCommand(sessionName, index) {
            if (!confirm('Delete this quick command?')) return;
            try {
                const response = await fetch(`${API_BASE}/api/commands/${sessionName}/${index}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    customCommands[sessionName] = data.commands;
                    updateQuickActionsBar(sessionName);
                }
            } catch (error) {
                showToast('Failed to delete command', 'error');
            }
        }

        function updateQuickActionsBar(sessionName) {
            const bar = document.getElementById(`quick-actions-${sessionName}`);
            if (!bar) return;
            const commands = customCommands[sessionName] || [];
            bar.innerHTML = `
                <span class="quick-actions-label">Quick Commands:</span>
                ${commands.map((cmd, i) => 
                    `<button class="btn-secondary btn-small" onclick="runCommand('${sessionName}', '${cmd.command.replace(/'/g, "\\'")}')">${cmd.label}</button><button class="btn-secondary btn-small" style="padding:6px 6px;margin-left:-4px;opacity:0.6" onclick="deleteQuickCommand('${sessionName}', ${i})" title="Delete">Ã—</button>`
                ).join('')}
                <button class="btn-secondary btn-small" onclick="showCommandModal('${sessionName}')">+ Add</button>
            `;
        }

        function refreshAll() { loadCommands().then(() => loadSessions()); }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('active'); });
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            if (e.ctrlKey && e.key === 't' && !e.target.closest('.terminal-container')) {
                e.preventDefault();
                showNewSessionModal();
            }
        });
    </script>
</body>
</html>